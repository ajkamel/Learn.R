// This is a manifest file that'll be compiled into application.js, which will include all the files
// listed below.
//
// Any JavaScript/Coffee file within this directory, lib/assets/javascripts, vendor/assets/javascripts,
// or vendor/assets/javascripts of plugins, if any, can be referenced here using a relative path.
//
// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
// compiled file.
//
// Read Sprockets README (https://github.com/sstephenson/sprockets#sprockets-directives) for details
// about supported directives.
//
//= require jquery
//= require jquery_ujs
//= require turbolinks
//= require_tree .

var starge, bird, background;
var birdImage = new Image();
var backgroundImage = new Image();
var startRow, startCol;
var solutionRow, solutionCol;
var xstep = 127;
var ystep = 74;
var pixelConverter = {x0: 33, y0: 10};

// var commandConverter = {'moveUp();': moveImageOneUnitUp,
//                         'moveDown();': moveImageOneUnitDown,
//                         'moveLeft();': moveImageOneUnitLeft,
//                         'moveRight();': moveImageOneUnitRight};

function getLesson() {
  var lessonID = $('.lesson-id').eq(0).data().id;
  var lesson = $.ajax({
    url: ('/code_lessons/' + lessonID),
    method: 'get',
    dataType: 'json',
    async: false
  });
  return lesson.responseJSON;
}

function init(lesson) {
  startRow = lesson.start_row;
  startCol = lesson.start_col;
  solutionRow = lesson.solution_row;
  solutionCol = lesson.solution_col;
  stage = new createjs.Stage(document.getElementById("lessoncanvas"));
  birdImage.src = "<%= asset_path 'bird.png' %>";
  birdImage.name = 'bird';
  backgroundImage.src = "<%= asset_path 'grid.png' %>";
  backgroundImage.name = 'background';
  backgroundImage.onload = loadGraphics;
}

function loadGraphics() {
  background = new createjs.Bitmap(backgroundImage);
  stage.addChild(background);
  bird = new createjs.Bitmap(birdImage);
  bird.x = startRow;
  bird.y = startCol;
  stage.addChild(bird);
  stage.update();
}

function throwError() {
  $('.errors').empty();
  $('.errors').append('<p>Oops looks like something went wrong</p>');
}
//Music Lessons Function Initialize
function initMusicLesson() {
    var keyLookup = {
    90: "c2",
    83: "c-2",
    88: "d2",
    68: "d-2",
    67: "e2",
    86: "f2",
    71: "f-2",
    66: "g2",
    72: "g-2",
    78: "a3",
    74: "a-3",
    77: "b3",
    81: "c3",
    50: "c-3",
    87: "d3",
    51: "d-3",
    69: "e3",
    82: "f3",
    53: "f-3",
    84: "g3",
    54: "g-3",
    89: "a4",
    55: "a-4",
    85: "b4",
    73: "c5"
  }

  var lessonSeq = "90, 88, 67, 86, 66, 78, 77, 81"; // this will come from database
  var lessonText = "Here is a C major scale. Can you play it?"
  var userInput = ""; //initialize empty strings for functions
  var keyCheck;
  var keyToPlay;
  var gameWon = false;

  // set event listeners for mouse and key presses
  $('.key').click(function(){
    var playKeyId = $(this).attr('id');
    playKey(playKeyId);
  });

  $('#lesson').click(function(){
    startLesson();
  })

  $( "body" ).on( "keydown", function( event ) {
    keyCheck = event.which;
    keyToPlay = keyLookup[keyCheck];
    $("#"+keyToPlay ).toggleClass("keyhover");
    playKey(keyToPlay);
    userInput += (keyCheck + ", ").toString();
    console.log(userInput);
  });

  $( "body" ).on( "keyup", function() {
    $('.key').removeClass('keyhover');
    if(!gameWon){
    checkAnswer(userInput);
    } else {
    userInput = "";
    gameWon = false;
    }
  });

  function playLesson(keyCheck){
    $("#"+keyLookup[keyCheck] ).toggleClass("keyhover");
    playKey(keyLookup[keyCheck]);
    $('.key').removeClass('keyhover');
  }

  function playKey(keyId){
    $('.player').empty();
    var fileName = keyId+'.mp3';
    var audioTag = $('<audio src=samples/' + keyId + '.mp3></audio>');
    audioTag.appendTo('.player');
    $('audio').eq(0).trigger('play');
  }

  function startLesson(){
    $('.lesson-player').empty(); // clear for no dupes.
    $('.lesson-player').append(lessonText);
    playSequence(lessonSeq);
  }

  function playSequence(seq){
    var notes = seq.split(', ');
    var max = notes.length;
    var counter = 0;
    var i = setInterval(function(){
      if (counter >= 0) {
        $('.key').removeClass('keyhover');
        var note = notes[counter];
         $("#"+keyLookup[note] ).addClass("keyhover");
        playKey(keyLookup[note]);
      }
      counter ++;
      if (counter > max) {
        clearInterval(i);
      }
    }, 500);
  }

  function checkAnswer(userInput){
    if (userInput.indexOf(lessonSeq) > -1) {
      gameWon = true;
      alert('You won!');
    }
  }
} //End Music Lesson

function ready() {
  if ($('#code_lessons_page')[0] !== undefined) {
    var lesson = getLesson();
    init(lesson);
    initMusicLesson();
  }
}


$(document).ready(ready);
$(document).on('page:load', ready);
